services:
  api_mariadb:
    image: mariadb:11.4
    container_name: ${COMPOSE_PROJECT_NAME:-simpleweb}-api-mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - api_mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 20s
      timeout: 10s
      retries: 5
    networks:
      - aea_network

  api-gateway:
    build:
      context: ../../api-gateway
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-simpleweb}-api-gateway
    restart: unless-stopped
    depends_on:
      api_mariadb:
        condition: service_healthy
    volumes:
      - ../../api-gateway:/app
      - /app/node_modules
    env_file:
      - ../../api-gateway/.env
    environment:
      DB_HOST: api_mariadb
      DB_PORT: 3306
      NODE_ENV: ${NODE_ENV:-production}
    ports:
      - "${API_GATEWAY_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - aea_network

  calc-bot:
    build:
      context: ../../calc-bot
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-simpleweb}-calc-bot
    restart: unless-stopped
    depends_on:
      api_mariadb:
        condition: service_healthy
    volumes:
      - ../../calc-bot:/app
      - /app/node_modules
    env_file:
      - ../../calc-bot/.env
    environment:
      DB_HOST: api_mariadb
      DB_PORT: 3306
      NODE_ENV: ${NODE_ENV:-production}
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - aea_network

  che-parser-bot:
    build:
      context: ../../che-parser-bot
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-simpleweb}-che-parser-bot
    restart: unless-stopped
    depends_on:
      api_mariadb:
        condition: service_healthy
    volumes:
      - ../../che-parser-bot:/app
      - /app/node_modules
    env_file:
      - ../../che-parser-bot/.env
    environment:
      DB_HOST: api_mariadb
      DB_PORT: 3306
      NODE_ENV: ${NODE_ENV:-production}
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - aea_network

  # sync-bot:
  #   build:
  #     context: ../../sync-bot
  #     dockerfile: Dockerfile
  #   container_name: ${COMPOSE_PROJECT_NAME:-simpleweb}-sync-bot
  #   restart: unless-stopped
  #   depends_on:
  #     api_mariadb:
  #       condition: service_healthy
  #   volumes:
  #     - ../../sync-bot:/app
  #     - /app/node_modules
  #   env_file:
  #     - ../../sync-bot/.env
  #   environment:
  #     DB_HOST: api_mariadb
  #     DB_PORT: 3306
  #     NODE_ENV: ${NODE_ENV:-production}
  #   healthcheck:
  #     test: ["CMD", "pgrep", "-f", "node"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   networks:
  #     - aea_network
